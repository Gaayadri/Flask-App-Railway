<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Avatar Mobile Client</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .status {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
        }
        
        .status.connected {
            background: #d4edda;
            color: #155724;
        }
        
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .input-section {
            margin-bottom: 20px;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        #messageInput {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
        }
        
        #messageInput:focus {
            border-color: #667eea;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 60px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a6fd8;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-voice {
            background: #28a745;
            color: white;
            font-size: 20px;
            width: 50px;
            padding: 12px;
        }
        
        .btn-voice.recording {
            background: #dc3545;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .response-section {
            margin-top: 20px;
        }
        
        .response-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        
        .response-meta {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .response-text {
            font-size: 16px;
            line-height: 1.4;
            color: #333;
        }
        
        .audio-controls {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .settings {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .settings label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .settings input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 AI Avatar</h1>
            <div id="connectionStatus" class="status disconnected">
                Connecting to server...
            </div>
        </div>
        
        <div class="input-section">
            <div class="input-group">
                <input 
                    type="text" 
                    id="messageInput" 
                    placeholder="Type your message..."
                    disabled
                />
                <button id="sendBtn" class="btn btn-primary" disabled>Send</button>
                <button id="voiceBtn" class="btn btn-voice">🎤</button>
            </div>
        </div>
        
        <div class="response-section">
            <div id="responses"></div>
        </div>
        
        <div class="settings">
            <label for="serverUrl">Server URL:</label>
            <input type="text" id="serverUrl" value="https://your-server.com" placeholder="https://your-deployed-server.com">
            <button id="connectBtn" class="btn btn-secondary">Connect</button>
        </div>
    </div>

    <script>
        class AIAvatarClient {
            constructor() {
                this.serverUrl = '';
                this.isConnected = false;
                this.isRecording = false;
                this.recognition = null;
                this.currentAudio = null;
                
                this.initializeElements();
                this.setupEventListeners();
                this.setupSpeechRecognition();
            }
            
            initializeElements() {
                this.messageInput = document.getElementById('messageInput');
                this.sendBtn = document.getElementById('sendBtn');
                this.voiceBtn = document.getElementById('voiceBtn');
                this.connectBtn = document.getElementById('connectBtn');
                this.serverUrlInput = document.getElementById('serverUrl');
                this.connectionStatus = document.getElementById('connectionStatus');
                this.responsesDiv = document.getElementById('responses');
            }
            
            setupEventListeners() {
                this.sendBtn.addEventListener('click', () => this.sendMessage());
                this.voiceBtn.addEventListener('click', () => this.toggleVoiceInput());
                this.connectBtn.addEventListener('click', () => this.connectToServer());
                
                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });
            }
            
            setupSpeechRecognition() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    this.recognition.continuous = false;
                    this.recognition.interimResults = false;
                    this.recognition.lang = 'en-US';
                    
                    this.recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        this.messageInput.value = transcript;
                        this.stopVoiceInput();
                    };
                    
                    this.recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        this.stopVoiceInput();
                    };
                    
                    this.recognition.onend = () => {
                        this.stopVoiceInput();
                    };
                } else {
                    this.voiceBtn.style.display = 'none';
                }
            }
            
            async connectToServer() {
                this.serverUrl = this.serverUrlInput.value.trim();
                if (!this.serverUrl) {
                    alert('Please enter a server URL');
                    return;
                }
                
                try {
                    this.updateConnectionStatus('Connecting...', false);
                    
                    const response = await fetch(`${this.serverUrl}/health`);
                    const data = await response.json();
                    
                    if (data.status === 'healthy') {
                        this.isConnected = true;
                        this.updateConnectionStatus('Connected', true);
                        this.enableInterface();
                    } else {
                        throw new Error('Server not healthy');
                    }
                } catch (error) {
                    this.isConnected = false;
                    this.updateConnectionStatus('Connection failed', false);
                    console.error('Connection error:', error);
                }
            }
            
            updateConnectionStatus(message, connected) {
                this.connectionStatus.textContent = message;
                this.connectionStatus.className = `status ${connected ? 'connected' : 'disconnected'}`;
            }
            
            enableInterface() {
                this.messageInput.disabled = false;
                this.sendBtn.disabled = false;
                this.voiceBtn.disabled = false;
            }
            
            async sendMessage() {
                const message = this.messageInput.value.trim();
                if (!message || !this.isConnected) return;
                
                this.messageInput.value = '';
                this.sendBtn.disabled = true;
                this.sendBtn.innerHTML = '<span class="loading"></span>';
                
                try {
                    const response = await fetch(`${this.serverUrl}/mobile-chat`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ text: message })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.displayResponse({
                            userMessage: message,
                            response: data.response,
                            source: data.source,
                            audioBase64: data.audio_base64,
                            audioSize: data.audio_size_kb
                        });
                    } else {
                        this.displayError(data.error || 'Unknown error occurred');
                    }
                } catch (error) {
                    this.displayError('Failed to send message: ' + error.message);
                } finally {
                    this.sendBtn.disabled = false;
                    this.sendBtn.textContent = 'Send';
                }
            }
            
            displayResponse(data) {
                const responseCard = document.createElement('div');
                responseCard.className = 'response-card';
                
                responseCard.innerHTML = `
                    <div class="response-meta">
                        You: ${data.userMessage}
                        <br>Source: ${data.source} • Audio: ${data.audioSize}KB
                    </div>
                    <div class="response-text">${data.response}</div>
                    <div class="audio-controls">
                        <button class="btn btn-secondary" onclick="client.playAudio('${data.audioBase64}')">
                            🔊 Play Audio
                        </button>
                        <button class="btn btn-secondary" onclick="client.stopAudio()">
                            ⏹️ Stop
                        </button>
                    </div>
                `;
                
                this.responsesDiv.insertBefore(responseCard, this.responsesDiv.firstChild);
            }
            
            displayError(errorMessage) {
                const errorCard = document.createElement('div');
                errorCard.className = 'response-card';
                errorCard.style.borderLeftColor = '#dc3545';
                errorCard.innerHTML = `
                    <div class="response-meta">Error</div>
                    <div class="response-text" style="color: #dc3545;">${errorMessage}</div>
                `;
                
                this.responsesDiv.insertBefore(errorCard, this.responsesDiv.firstChild);
            }
            
            playAudio(audioBase64) {
                this.stopAudio();
                
                const audioBlob = this.base64ToBlob(audioBase64, 'audio/wav');
                const audioUrl = URL.createObjectURL(audioBlob);
                
                this.currentAudio = new Audio(audioUrl);
                this.currentAudio.play();
                
                this.currentAudio.onended = () => {
                    URL.revokeObjectURL(audioUrl);
                    this.currentAudio = null;
                };
            }
            
            stopAudio() {
                if (this.currentAudio) {
                    this.currentAudio.pause();
                    this.currentAudio = null;
                }
            }
            
            base64ToBlob(base64, mimeType) {
                const byteCharacters = atob(base64);
                const byteNumbers = new Array(byteCharacters.length);
                
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                
                const byteArray = new Uint8Array(byteNumbers);
                return new Blob([byteArray], { type: mimeType });
            }
            
            toggleVoiceInput() {
                if (this.isRecording) {
                    this.stopVoiceInput();
                } else {
                    this.startVoiceInput();
                }
            }
            
            startVoiceInput() {
                if (this.recognition) {
                    this.isRecording = true;
                    this.voiceBtn.classList.add('recording');
                    this.voiceBtn.textContent = '⏹️';
                    this.recognition.start();
                }
            }
            
            stopVoiceInput() {
                if (this.recognition && this.isRecording) {
                    this.isRecording = false;
                    this.voiceBtn.classList.remove('recording');
                    this.voiceBtn.textContent = '🎤';
                    this.recognition.stop();
                }
            }
        }
        
        // Initialize the client
        const client = new AIAvatarClient();
    </script>
</body>
</html>
